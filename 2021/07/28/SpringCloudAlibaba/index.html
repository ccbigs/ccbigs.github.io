<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SpringCloudAlibaba | ccbigs blog</title><meta name="author" content="DingQuan Zuo"><meta name="copyright" content="DingQuan Zuo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SpringCloudAlibabahttps:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;spring-cloud-alibaba&#x2F;blob&#x2F;master&#x2F;README-zh.md 1.Nacos 服务注册和配置中心Nacos&#x3D;Eureka(服务注册中心)+Config服务配置+Bus服务总线 1.1 下载并安装Nacos我们下载稳定版即可： https:&#x2F;&#x2F;github.com&#x2F;ali">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloudAlibaba">
<meta property="og:url" content="http://example.com/2021/07/28/SpringCloudAlibaba/index.html">
<meta property="og:site_name" content="ccbigs blog">
<meta property="og:description" content="SpringCloudAlibabahttps:&#x2F;&#x2F;github.com&#x2F;alibaba&#x2F;spring-cloud-alibaba&#x2F;blob&#x2F;master&#x2F;README-zh.md 1.Nacos 服务注册和配置中心Nacos&#x3D;Eureka(服务注册中心)+Config服务配置+Bus服务总线 1.1 下载并安装Nacos我们下载稳定版即可： https:&#x2F;&#x2F;github.com&#x2F;ali">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/ahead.jpg">
<meta property="article:published_time" content="2021-07-28T02:12:45.000Z">
<meta property="article:modified_time" content="2024-10-22T11:54:01.389Z">
<meta property="article:author" content="DingQuan Zuo">
<meta property="article:tag" content="SpringCLoud">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/ahead.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2021/07/28/SpringCloudAlibaba/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringCloudAlibaba',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-22 19:54:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/ahead.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/1558.png')"><nav id="nav"><span id="blog-info"><a href="/" title="ccbigs blog"><img class="site-icon" src="/img/favicon.png"/><span class="site-name">ccbigs blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloudAlibaba</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-07-28T02:12:45.000Z" title="发表于 2021-07-28 10:12:45">2021-07-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-22T11:54:01.389Z" title="更新于 2024-10-22 19:54:01">2024-10-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/">Spring</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>49分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="SpringCloudAlibaba"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="SpringCloudAlibaba"><a href="#SpringCloudAlibaba" class="headerlink" title="SpringCloudAlibaba"></a>SpringCloudAlibaba</h1><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<h2 id="1-Nacos-服务注册和配置中心"><a href="#1-Nacos-服务注册和配置中心" class="headerlink" title="1.Nacos 服务注册和配置中心"></a>1.Nacos 服务注册和配置中心</h2><p><strong>Nacos&#x3D;Eureka(服务注册中心)+Config服务配置+Bus服务总线</strong></p>
<h3 id="1-1-下载并安装Nacos"><a href="#1-1-下载并安装Nacos" class="headerlink" title="1.1 下载并安装Nacos"></a>1.1 下载并安装Nacos</h3><p>我们下载稳定版即可：</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></strong></p>
<p>下载好了之后，我们解压到指定文件夹：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731143103.png"></p>
<p>进入到文件的bin目录下：在地址框中输入：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startup.<span class="built_in">cmd</span> -m standalone   #这里的-m standalone是表示做单机版的</span><br></pre></td></tr></table></figure>

<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731143213.png"></p>
<p>启动成功后，我们输入：localhost:8848&#x2F;nacos进入到登陆页面：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731143406.png"></p>
<p>默认<strong>登陆的账号：nacos  密码：nacos</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731143453.png"></p>
<p>成功进入。</p>
<h3 id="1-2-服务注册进入Nacos"><a href="#1-2-服务注册进入Nacos" class="headerlink" title="1.2 服务注册进入Nacos"></a>1.2 服务注册进入Nacos</h3><h4 id="1-2-1-新建客户端服务"><a href="#1-2-1-新建客户端服务" class="headerlink" title="1.2.1 新建客户端服务"></a>1.2.1 新建客户端服务</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731143552.png"></p>
<h4 id="1-2-2-添加pom依赖"><a href="#1-2-2-添加pom依赖" class="headerlink" title="1.2.2 添加pom依赖"></a>1.2.<strong>2 添加pom依赖</strong></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>声明一下，这里的父依赖如下，cloud版本还是H版本的，但是alibaba的版本是2.2.1的</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 统一管理jar包版本 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mybatis.spring.boot.version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">mybatis.spring.boot.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 子模块继承之后，提供作用：锁定版本+子modlue不用写groupId和version  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring boot 2.2.2--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring cloud Hoxton.SR1--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring cloud alibaba 2.1.0.RELEASE--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="1-2-3-创建主启动类"><a href="#1-2-3-创建主启动类" class="headerlink" title="1.2.3 创建主启动类"></a>1.2.3 创建主启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:左泽林</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:日期:2021-07-31-时间:14:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@message</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain9001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(PaymentMain9001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-2-4-创建controller类"><a href="#1-2-4-创建controller类" class="headerlink" title="1.2.4 创建controller类"></a>1.2.4 创建controller类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;nacos registry, serverPort: &quot;</span>+ serverPort+<span class="string">&quot;\t id&quot;</span>+id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-2-6-配置yml"><a href="#1-2-6-配置yml" class="headerlink" title="1.2.6 配置yml"></a>1.2.6 配置yml</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置Nacos地址</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-2-7-启动项目"><a href="#1-2-7-启动项目" class="headerlink" title="1.2.7 启动项目"></a>1.2.7 启动项目</h4><p>查看9001是否注册进入nacos</p>
<p>输入nacos地址，进入管理页面：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731144033.png"></p>
<p>按照上面的步骤新建9002</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731144815.png"></p>
<p>我们进入nacos的管理界面：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731144845.png"></p>
<p>我们可以看到集群数目有两个了，我们点击<strong>详情</strong>查看</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731144948.png"></p>
<h3 id="1-3消费者入驻Nacos"><a href="#1-3消费者入驻Nacos" class="headerlink" title="1.3消费者入驻Nacos"></a>1.3消费者入驻Nacos</h3><h4 id="1-3-1创建消费微服务"><a href="#1-3-1创建消费微服务" class="headerlink" title="1.3.1创建消费微服务"></a>1.3.1创建消费微服务</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731152250.png"></p>
<h4 id="1-3-2-新建启动类"><a href="#1-3-2-新建启动类" class="headerlink" title="1.3.2 新建启动类"></a>1.3.2 新建启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:左泽林</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:日期:2021-07-31-时间:15:01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@message</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNacosMain83</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderNacosMain83.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-3-3-创建yml"><a href="#1-3-3-创建yml" class="headerlink" title="1.3.3 创建yml"></a>1.3.3 创建yml</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9083</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span>  <span class="comment">#使用 nacos-user-service可以直接引用改服务集群</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-3-4-创建config类"><a href="#1-3-4-创建config类" class="headerlink" title="1.3.4 创建config类"></a>1.3.4 创建config类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-3-5-创建controller类"><a href="#1-3-5-创建controller类" class="headerlink" title="1.3.5 创建controller类"></a>1.3.5 创建controller类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>:左泽林</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>:日期:2021-07-31-时间:15:03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@message</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNacosController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverURL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(serverURL+<span class="string">&quot;/payment/nacos/&quot;</span>+id,String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-3-6-启动项目"><a href="#1-3-6-启动项目" class="headerlink" title="1.3.6 启动项目"></a>1.3.6 启动项目</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731152555.png"></p>
<p>消费者成功注册。</p>
<p>通过消费者访问客户端集群：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731152639.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731152651.png"></p>
<p>实现了负载均衡的轮询访问，因为nacos融入了ribbon</p>
<h3 id="1-4-Nacos作为服务配置中心演示"><a href="#1-4-Nacos作为服务配置中心演示" class="headerlink" title="1.4 Nacos作为服务配置中心演示"></a>1.4 Nacos作为服务配置中心演示</h3><p><strong>nacos集合了config服务配置</strong></p>
<h4 id="1-4-1-创建项目"><a href="#1-4-1-创建项目" class="headerlink" title="1.4.1  创建项目"></a>1.4.1  创建项目</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731155010.png"></p>
<h4 id="1-4-2-导入pom"><a href="#1-4-2-导入pom" class="headerlink" title="1.4.2 导入pom"></a>1.4.2 导入pom</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--nacos-config--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--nacos-discovery--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web + actuator--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--一般基础配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-4-3-配置yml"><a href="#1-4-3-配置yml" class="headerlink" title="1.4.3 配置yml"></a>1.4.3 配置yml</h4><p>Nacos同springcloud-config-样,项目初始化时，要保证先从配置中心进行配置拉取,拉取配置之后，才能保证项目的正常启动。</p>
<p>springboot中配置文件的加载是存在优先级顺序的，&#x3D;&#x3D;bootstrap优先级高于application&#x3D;&#x3D;</p>
<p><strong>bootstrap.yml</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#服务注册中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#指定yaml格式的配置</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>application.yml</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731162212.png"></p>
<h4 id="1-4-4-配置主启动类"><a href="#1-4-4-配置主启动类" class="headerlink" title="1.4.4 配置主启动类"></a>1.4.4 配置主启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosConfigClientMain3377</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(NacosConfigClientMain3377.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-4-5-配置Controller"><a href="#1-4-5-配置Controller" class="headerlink" title="1.4.5 配置Controller"></a>1.4.5 配置Controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">//支持nacos的动态刷新数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-4-6-配置nacos中的配置列表"><a href="#1-4-6-配置nacos中的配置列表" class="headerlink" title="1.4.6 配置nacos中的配置列表"></a>1.4.6 配置nacos中的配置列表</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731162633.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731162830.png"></p>
<p><strong>此处不能写成yml，必须要写成，不然启动时，会报错</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731164024.png"></p>
<p><strong>写好之后启动项目，输入链接查询</strong></p>
<p><a target="_blank" rel="noopener" href="http://localhost:3377/config/info">http://localhost:3377/config/info</a></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731164935.png"></p>
<h4 id="1-4-7-Nacos自带刷新功能"><a href="#1-4-7-Nacos自带刷新功能" class="headerlink" title="1.4.7 Nacos自带刷新功能"></a>1.4.7 Nacos自带刷新功能</h4><p>修改下Nacos中的yaml配置文件，再次调用查看配置的接口，就会发现配置已经刷新</p>
<p>将version&#x3D;1 改成version&#x3D;2</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731165152.png"></p>
<p>输入连接：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:3377/config/info">http://localhost:3377/config/info</a></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731165305.png"></p>
<h3 id="1-5-Nacos作为配置中心-分类配置"><a href="#1-5-Nacos作为配置中心-分类配置" class="headerlink" title="1.5 Nacos作为配置中心-分类配置"></a>1.5 Nacos作为配置中心-分类配置</h3><h4 id="1-5-1-多环境多项目管理"><a href="#1-5-1-多环境多项目管理" class="headerlink" title="1.5.1 多环境多项目管理"></a>1.5.1 多环境多项目管理</h4><p>问题1:</p>
<p>实际开发中，通常一个 系统会准备</p>
<p>dev开发环境</p>
<p>test测试环境</p>
<p>prod生产环境。</p>
<p>如何保证指定环境启动时服务能正确读取到Nacos_上相应环境的配置文件呢?</p>
<p>问题2:</p>
<p>一个大型分布式微服务系统会有很多微服务子项目,</p>
<p>每个微服务项目又都会有相应的开发环境、测试环境、预发环境、正式环境….</p>
<p>那怎么对这些微服务配置进行管理呢?</p>
<h4 id="1-5-2-Nacos图形化设计页面"><a href="#1-5-2-Nacos图形化设计页面" class="headerlink" title="1.5.2 Nacos图形化设计页面"></a>1.5.2 Nacos图形化设计页面</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731171509.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731171546.png"></p>
<h4 id="1-5-3-Namespace-Group-Data-ID三者关系"><a href="#1-5-3-Namespace-Group-Data-ID三者关系" class="headerlink" title="1.5.3 Namespace+Group+Data ID三者关系"></a>1.5.3 Namespace+Group+Data ID三者关系</h4><p><strong>是什么？</strong></p>
<p>以上三者类似Java里面的package名和类名</p>
<p>最外层的namespace是可以用于区分部署环境的，Group和DatalD逻辑上区分两个目标对象。</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731172310.png"></p>
<p>默认情况:</p>
<p>&#x3D;&#x3D;Namespace&#x3D;public, Group&#x3D;DEFAULT_ GROUP,默认Cluster是DEFAULT&#x3D;&#x3D;</p>
<p>Nacos默认的命名空间是public, Namespace主要用来实现隔离。</p>
<p>比方说我们现在有三个环境:开发、测试、产环境,我们就可以创建E个Namespace, 不同的Namespace之间是隔离的。</p>
<p>Group默认是DEFAULT_ GROUP, Group可以把不同的微服务划分到同一个分组里面去</p>
<p>Service就是微服务; -个Service可以包含多个Cluster (集群)，Nacos默认Cluster是DEFAULT, Cluster是对指定微服务的一个虚拟划分。</p>
<p>比方说为了容灾，将Service微服务分别部署在了杭州机房和广州机房,这时就可以给杭州机房的Service微服务起一个集群名称(HZ) ,给广州机房的Service微服务起一个集群名称 (GZ)，还可以尽量让同一个机房的微服务互相调用，以提升性能。</p>
<p>最后是Instance,就是微服务的实例。</p>
<h5 id="1-5-3-1-Nacos之DataID配置"><a href="#1-5-3-1-Nacos之DataID配置" class="headerlink" title="1.5.3.1 Nacos之DataID配置"></a>1.5.3.1 Nacos之DataID配置</h5><p>新建yaml文件</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731173013.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731173039.png"></p>
<p><strong>更改配置信息</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731173159.png"></p>
<p>重新启动</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731180645.png"></p>
<p>我们就访问到text了</p>
<p>&#x3D;&#x3D;配置是什么就加载什么&#x3D;&#x3D;</p>
<h5 id="1-5-3-2-Group组"><a href="#1-5-3-2-Group组" class="headerlink" title="1.5.3.2 Group组"></a>1.5.3.2 Group组</h5><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731180928.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731181009.png"></p>
<p><strong>举例：</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731181310.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731181343.png"></p>
<p><strong>项目中的yml配置</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731181538.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731181700.png"></p>
<p><strong>重启项目</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731181755.png"></p>
<h5 id="1-5-1-3-NameSpace空间方案"><a href="#1-5-1-3-NameSpace空间方案" class="headerlink" title="1.5.1.3 NameSpace空间方案"></a>1.5.1.3 NameSpace空间方案</h5><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731182033.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731182130.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731182146.png"></p>
<p><strong>可以看到我们新建的命令空间了</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731182232.png"></p>
<p><strong>在新建的命名空间中进行操作</strong></p>
<p>先将dev的id赋值：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731182654.png"></p>
<p><strong>打开bootstrap.yml配置文件</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731182836.png"></p>
<p>新建配置管理数据：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731182446.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731183112.png"></p>
<p><strong>重新启动项目：</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731183516.png"></p>
<h3 id="1-6-Nacos集群和持久化配置"><a href="#1-6-Nacos集群和持久化配置" class="headerlink" title="1.6 Nacos集群和持久化配置"></a>1.6 Nacos集群和持久化配置</h3><h4 id="1-6-x-Nacos集群配置"><a href="#1-6-x-Nacos集群配置" class="headerlink" title="1.6.x Nacos集群配置"></a>1.6.x Nacos集群配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">三个nacos： 7741 7742 4242</span><br></pre></td></tr></table></figure>





<h4 id="1-配置mysql的sql文件"><a href="#1-配置mysql的sql文件" class="headerlink" title="1. 配置mysql的sql文件"></a>1. 配置mysql的sql文件</h4><p>阅读网址：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html">https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html</a></p>
<p>下载网址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/tree/master/distribution/conf">https://github.com/alibaba/nacos/tree/master/distribution/conf</a></p>
<h4 id="2-application-properties-配置"><a href="#2-application-properties-配置" class="headerlink" title="2. application.properties 配置"></a>2. application.properties 配置</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zuodingquan666/article/details/119394978">(26条消息) Nacos集群:2021最新款高可用Nacos服务注册集群搭建_zuodingquan666的博客-CSDN博客</a></p>
<h2 id="2-Sentinel-哨兵"><a href="#2-Sentinel-哨兵" class="headerlink" title="2.Sentinel 哨兵"></a>2.Sentinel 哨兵</h2><p><strong>你的微服务哨兵</strong></p>
<p><strong>Hystrix存在的问题</strong></p>
<ol>
<li>需要我们程序员自己手动搭建监控平台</li>
<li>没有一套web界面可以给我们进行更加细粒度的配置<ol>
<li>流控</li>
<li>速率的控制</li>
<li>服务熔断</li>
<li>服务降级</li>
</ol>
</li>
</ol>
<p><strong>Sentinel的解决方法</strong></p>
<ol>
<li>单独一个组件</li>
<li>直接界面化的细粒度统一配置</li>
</ol>
<h3 id="2-1-初识Sentinel"><a href="#2-1-初识Sentinel" class="headerlink" title="2.1 初识Sentinel"></a>2.1 初识Sentinel</h3><p><strong>Sentinel是什么</strong></p>
<p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p>
<p><strong>Sentinel的特点</strong></p>
<ul>
<li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li>
<li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li>
<li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架&#x2F;库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li>
<li><strong>完善的 SPI 扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等</li>
</ul>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805092322789.png" alt="image-20210805092322789"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805092506926.png" alt="image-20210805092506926"></p>
<h3 id="2-2-下载、安装、配置"><a href="#2-2-下载、安装、配置" class="headerlink" title="2.2 下载、安装、配置"></a>2.2 下载、安装、配置</h3><p><strong>下载网址</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a></p>
<p><strong>2.如何启动sentinel</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805094931664.png" alt="image-20210805094931664"></p>
<p>下载好Sentinel的jar包之后，在存放Sentinel的目录下</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805095058499.png" alt="image-20210805095058499"></p>
<p>这里需要注意的是，Sentinel启动需要的是8080端口，所以需要确保8080端口没有被占用。</p>
<p>启动成功后：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805095335742.png" alt="image-20210805095335742"></p>
<p>输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:8080</span><br></pre></td></tr></table></figure>

<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805095257974.png" alt="image-20210805095257974"></p>
<ul>
<li>账号：sentinel</li>
<li>密码：sentinel</li>
</ul>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805095410722.png" alt="image-20210805095410722"></p>
<h3 id="2-3-Sentinel监控微服务"><a href="#2-3-Sentinel监控微服务" class="headerlink" title="2.3 Sentinel监控微服务"></a>2.3 Sentinel监控微服务</h3><h4 id="2-3-1-新建微服务"><a href="#2-3-1-新建微服务" class="headerlink" title="2.3.1 新建微服务"></a>2.3.1 新建微服务</h4><p>微服务名：cloudalibaba-sentinel-service8401</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805095824136.png" alt="image-20210805095824136"></p>
<h4 id="2-3-2-建POM"><a href="#2-3-2-建POM" class="headerlink" title="2.3.2 建POM"></a>2.3.2 建POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="2-3-3-主启动类"><a href="#2-3-3-主启动类" class="headerlink" title="2.3.3 主启动类"></a>2.3.3 主启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">sentinelMain8401</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(sentinelMain8401.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-3-4-controller类"><a href="#2-3-4-controller类" class="headerlink" title="2.3.4 controller类"></a>2.3.4 controller类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlowLimitController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testA</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------testA&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testB&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testB</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------testB&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-3-5-Sentinel"><a href="#2-3-5-Sentinel" class="headerlink" title="2.3.5 Sentinel"></a>2.3.5 Sentinel</h4><p>我们登入sentinel界面，空空如也。因为Sentinel使用的是懒加载机制。</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805102802334.png" alt="image-20210805102802334"></p>
<p>解决方法：</p>
<p>执行访问：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">localhost:8401/testA</span><br><span class="line"></span><br><span class="line">localhost:8401/testB</span><br></pre></td></tr></table></figure>

<p><strong>刷新Sentinel</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805103022775.png" alt="image-20210805103022775"></p>
<p>我们的服务已出现</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805103218890.png" alt="image-20210805103218890"></p>
<h3 id="2-4-Sentinel流控规则简介"><a href="#2-4-Sentinel流控规则简介" class="headerlink" title="2.4 Sentinel流控规则简介"></a>2.4 Sentinel流控规则简介</h3><p><strong>位置</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805103436413.png" alt="image-20210805103436413"></p>
<ul>
<li>资源名：唯一名称，默认请求路径</li>
<li>针对来源：Sentinel可以针对调用者进行限流，填写微服务名，默认default（不区分来源）</li>
<li>阀值类型&#x2F;单机阈值<ul>
<li>QPS (每秒钟的请求数量) :当调用该api的QPS达到阈值的时候，进行限流</li>
<li>线程数:当调用该api的线程数达到阈值的时候,进行限流</li>
</ul>
</li>
<li>是否集群：不需要集群</li>
<li>流控模式：<ul>
<li>直接: api达到限流条件时，直接限流</li>
<li>关联：当关联的资源达到阈值的时候，就限流自己</li>
<li>链路:只记录指定链路上的流量(指定资源从入口资源进来的流量,如果达到阈值，就进行限流) [api级<br>别的针对来源】</li>
</ul>
</li>
<li>流控效果：<ul>
<li>快速失败:直接失败，抛异常</li>
<li>Warm Up:根据codeFactor (冷加载因子，默认3)的值,从阈值&#x2F;codeFactor, 经过预热时长，才达到设<br>置的QPS阈值</li>
<li>排队等待:匀速排队，让请求以匀速的速度通过,阈值类型必须设置为QPS,否则无效</li>
</ul>
</li>
</ul>
<h4 id="2-4-2-编写流控规则"><a href="#2-4-2-编写流控规则" class="headerlink" title="2.4.2 编写流控规则"></a>2.4.2 编写流控规则</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805104600600.png" alt="image-20210805104600600"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805104848831.png" alt="image-20210805104848831"></p>
<p>我们访问：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:8401/textA</span><br></pre></td></tr></table></figure>

<p>每秒点一次，没毛病</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805104936869.png" alt="image-20210805104936869"></p>
<p><strong>狂点：</strong></p>
<p>出现失败策略</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805104958199.png" alt="image-20210805104958199"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805105027582.png" alt="image-20210805105027582"></p>
<h4 id="2-4-3-思考"><a href="#2-4-3-思考" class="headerlink" title="2.4.3 思考"></a>2.4.3 思考</h4><p>技术上面都ok，但是页面提示信息能不能更友好一点，而且是否应该有我们自己的后续处理？</p>
<p><strong>类似有一个fallback的兜底方法？</strong></p>
<h4 id="2-4-4-流控模式-关联"><a href="#2-4-4-流控模式-关联" class="headerlink" title="2.4.4 流控模式-关联"></a>2.4.4 流控模式-关联</h4><p>当关联的资源达到阈值时，就限流自己。</p>
<p>当与A关联的资源B达到阈值后，就限流自己：B惹事，A挂了</p>
<p>举例：支付接口满流之后，<strong>就限制下订单的接口</strong>，因为下订单的接口数量变少了，会可以缓解支付接口的压力</p>
<p>我们配置的是，大规模访问&#x2F;testB，导致&#x2F;testA挂了</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805114037384.png" alt="image-20210805114037384"></p>
<p><strong>使用postman发送请求</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805114125013.png" alt="image-20210805114125013"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805114220720.png" alt="image-20210805114220720"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805114322733.png" alt="image-20210805114322733"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805114419198.png" alt="image-20210805114419198"></p>
<p>点击开始，B被无线访问，A已经进不去了：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805114733412.png" alt="image-20210805114733412"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805114726097.png" alt="image-20210805114726097"></p>
<h4 id="2-4-5-流控模式-链路"><a href="#2-4-5-流控模式-链路" class="headerlink" title="2.4.5 流控模式-链路"></a>2.4.5 流控模式-链路</h4><h4 id="2-4-6-流控效果-Warm-Up-预热"><a href="#2-4-6-流控效果-Warm-Up-预热" class="headerlink" title="2.4.6 流控效果-Warm Up(预热)"></a>2.4.6 流控效果-Warm Up(预热)</h4><p>公式：阈值除以coldFactor（默认值为3），经过预热时长后才会达到阈值</p>
<p>Warm Up（<code>RuleConstant.CONTROL_BEHAVIOR_WARM_UP</code>）方式，即预热&#x2F;冷启动方式。当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过”冷启动”，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805141610408.png" alt="image-20210805141610408"></p>
<p><strong>默认的clodFactor为3</strong>，即请求QPS从threshold&#x2F;3开始，经预热时长逐渐升至设定的QPS阈值</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805142130756.png" alt="image-20210805142130756"></p>
<p><strong>示例：</strong></p>
<p>系统初始化的阈值为10，预热时长设置了5秒。系统初始化的阈值为10&#x2F;3约等于3，即阈值刚开始为3；然后过了5秒后阈值才慢慢升高恢复到10。</p>
<p>一开始访问A还会显示错误，但是五秒之后就稳定下来了。</p>
<h4 id="2-4-7-流控效果-排队等待"><a href="#2-4-7-流控效果-排队等待" class="headerlink" title="2.4.7 流控效果-排队等待"></a>2.4.7 流控效果-排队等待</h4><p>匀速排队（<code>RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER</code>）方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法。详细文档可以参考 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6-%E5%8C%80%E9%80%9F%E6%8E%92%E9%98%9F%E6%A8%A1%E5%BC%8F">流量控制 - 匀速器模式</a>，具体的例子可以参见 <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/blob/master/sentinel-demo/sentinel-demo-basic/src/main/java/com/alibaba/csp/sentinel/demo/flow/PaceFlowDemo.java">PaceFlowDemo</a>。</p>
<p>该方式的作用如下图所示：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805143139648.png" alt="image-20210805143139648"></p>
<p>这种方式主要用于处理间隔性突发的流量，例如消息队列。想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</p>
<blockquote>
<p>注意：匀速排队模式暂时不支持 QPS &gt; 1000 的场景。</p>
</blockquote>
<p>匀速排队，让请求以均匀的速度通过，阈值类型必须设成QPS，否则无效</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805143008431.png" alt="image-20210805143008431"></p>
<p>设置含义： &#x2F;testA每秒1次请求，超过的话就排队等待，等待的超时时间为20000毫秒</p>
<p><strong>在Controller</strong>层：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805144256494.png" alt="image-20210805144256494"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log.info(Thread.currentThread().getName()+&quot;\t&quot;+&quot;.....testB&quot;);</span><br></pre></td></tr></table></figure>

<p>然后再postman设置并发数：</p>
<p>后台可以看到进程：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805144337860.png" alt="image-20210805144337860"></p>
<h3 id="2-5-Sentinel降级规则"><a href="#2-5-Sentinel降级规则" class="headerlink" title="2.5 Sentinel降级规则"></a>2.5 Sentinel降级规则</h3><p>除了流量控制以外，对调用链路中不稳定的资源进行熔断降级也是保障高可用的重要措施之一。一个服务常常会调用别的模块，可能是另外的一个远程服务、数据库，或者第三方 API 等。例如，支付的时候，可能需要远程调用银联提供的 API；查询某个商品的价格，可能需要进行数据库查询。然而，这个被依赖服务的稳定性是不能保证的。如果依赖的服务出现了不稳定的情况，请求的响应时间变长，那么调用服务的方法的响应时间也会变长，线程会产生堆积，最终可能耗尽业务自身的线程池，服务本身也变得不可用。</p>
<p><img src="https://user-images.githubusercontent.com/9434884/62410811-cd871680-b61d-11e9-9df7-3ee41c618644.png" alt="chain"></p>
<p>现代微服务架构都是分布式的，由非常多的服务组成。不同服务之间相互调用，组成复杂的调用链路。以上的问题在链路调用中会产生放大的效果。复杂链路上的某一环不稳定，就可能会层层级联，最终导致整个链路都不可用。因此我们需要对不稳定的<strong>弱依赖服务调用</strong>进行熔断降级，暂时切断不稳定调用，避免局部不稳定因素导致整体的<strong>雪崩</strong>。熔断降级作为保护自身的手段，通常在客户端（调用端）进行配置。</p>
<p><strong>注意</strong>：本文档针对 Sentinel 1.8.0 及以上版本。1.8.0 版本对熔断降级特性进行了全新的改进升级，请使用最新版本以更好地利用熔断降级的能力。</p>
<h4 id="2-5-1-熔断策略"><a href="#2-5-1-熔断策略" class="headerlink" title="2.5.1 熔断策略"></a>2.5.1 熔断策略</h4><p>Sentinel 提供以下几种熔断策略：</p>
<ul>
<li>慢调用比例 (<code>SLOW_REQUEST_RATIO</code>)：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（<code>statIntervalMs</code>）内<strong>请求数目大于设置的最小请求数目</strong>，并且<strong>慢调用的比例大于阈值</strong>，则接下来的熔断时长内请求会<strong>自动被熔断</strong>。经过熔断时长后熔断器会进入**探测恢复(Hystix的功能，Sentinel1.8版本后有的)**状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</li>
<li>异常比例 (<code>ERROR_RATIO</code>)：当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 0% - 100%。</li>
<li>异常数 (<code>ERROR_COUNT</code>)：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</li>
</ul>
<h4 id="2-5-2-熔断策略-慢调用比例"><a href="#2-5-2-熔断策略-慢调用比例" class="headerlink" title="2.5.2 熔断策略-慢调用比例"></a>2.5.2 熔断策略-慢调用比例</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805154751491.png" alt="image-20210805154751491"></p>
<p>慢调用比例 (<code>SLOW_REQUEST_RATIO</code>)：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（<code>statIntervalMs</code>）内<strong>请求数目大于设置的最小请求数目</strong>，并且<strong>慢调用的比例大于阈值</strong>，则接下来的熔断时长内请求会<strong>自动被熔断</strong>。经过熔断时长后熔断器会进入**探测恢复(Hystix的功能，Sentinel1.8版本后有的)**状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805152328764.png" alt="image-20210805152328764"></p>
<p><strong>测试：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testD&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testD</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//暂停几秒钟线程</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testD,测试Sentinel1.8版本后的慢调用比例&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805193147181.png" alt="image-20210805193147181"></p>
<p>Jmeter使用方法：<a target="_blank" rel="noopener" href="https://blog.csdn.net/yaorongke/article/details/82799609?ops_request_misc=%7B%22request_id%22:%22162816218916780264070536%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=162816218916780264070536&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-82799609.pc_search_all_es&utm_term=jmeter%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95&spm=1018.2226.3001.4187">(27条消息) Jmeter教程(一) - 入门_淡淡的说非-CSDN博客_jmeter</a></p>
<p>Jmeter压力测试：发送线程数100个，持续2秒</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805192852872.png" alt="image-20210805192852872"></p>
<p>我们测试：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805193003757.png" alt="image-20210805193003757"></p>
<p>一开始没问题：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805193025275.png" alt="image-20210805193025275"></p>
<p>Jmeter启动后：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805193046274.png" alt="image-20210805193046274"></p>
<p>我们发现已经熔断了，我们等待6秒</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805193116896.png" alt="image-20210805193116896"></p>
<p><strong>恢复如初</strong></p>
<h4 id="2-5-3-熔断策略-异常比例"><a href="#2-5-3-熔断策略-异常比例" class="headerlink" title="2.5.3 熔断策略-异常比例"></a>2.5.3 熔断策略-异常比例</h4><p>当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 0% - 100%。</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805193908148.png" alt="image-20210805193908148"></p>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testE&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">testE</span><span class="params">()</span>&#123;</span><br><span class="line">       </span><br><span class="line">       <span class="type">int</span> g=<span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;testE,异常比例&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805194013572.png" alt="image-20210805194013572"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805194041421.png" alt="image-20210805194041421"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805194252963.png" alt="image-20210805194252963"></p>
<p>恢复之后又可以重新访问了：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805194355156.png" alt="image-20210805194355156"></p>
<p><strong>断路器开启（保险丝跳闸），微服务不可用了，不再报错error而是服务降级了</strong></p>
<h4 id="2-5-4-熔断策略-异常数"><a href="#2-5-4-熔断策略-异常数" class="headerlink" title="2.5.4 熔断策略-异常数"></a>2.5.4 熔断策略-异常数</h4><p>异常数 (<code>ERROR_COUNT</code>)：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</p>
<p>默认时长1分钟</p>
<h3 id="2-6-Sentinel-热点规则"><a href="#2-6-Sentinel-热点规则" class="headerlink" title="2.6 Sentinel 热点规则"></a>2.6 Sentinel 热点规则</h3><p><strong>很常用的</strong></p>
<p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p>
<ul>
<li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li>
<li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li>
</ul>
<p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。</p>
<p>Sentinel 利用 LRU 策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。热点参数限流支持集群模式。</p>
<h4 id="2-6-1-基本配置示例"><a href="#2-6-1-基本配置示例" class="headerlink" title="2.6.1 基本配置示例"></a>2.6.1 基本配置示例</h4><p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * @author: 左先生</span></span><br><span class="line"><span class="comment">    * @date: 2021-08-05 20:06</span></span><br><span class="line"><span class="comment">    * @description:这里对SentinelResource进行说明：</span></span><br><span class="line"><span class="comment">    * value=&quot;testHotKey&quot;,testHotKey是在sentinel配置中的命名</span></span><br><span class="line"><span class="comment">    * blockHandler = &quot;deal_testHotKey&quot;，兜底方案</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/testHotKey&quot;)</span></span><br><span class="line">   <span class="meta">@SentinelResource(value = &quot;testHotKey&quot;, blockHandler = &quot;deal_testHotKey&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">testHotKey</span><span class="params">(<span class="meta">@RequestParam(value = &quot;p1&quot;,required = false)</span> String p1,</span></span><br><span class="line"><span class="params">                            <span class="meta">@RequestParam(value = &quot;p1&quot;,required = false)</span> String p2)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;-----testHotKey&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">deal_testHotKey</span><span class="params">(String p1, String p2, BlockException exception)</span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;------deal_testHotKey,/(ㄒoㄒ)/~~&quot;</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805202450463.png" alt="image-20210805202450463"></p>
<p>测试结果：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805201847483.png" alt="image-20210805201847483"></p>
<p>突然加快点击速度，超出设置的阈值</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805202224169.png" alt="image-20210805202224169"></p>
<p><strong>显而易见，他执行了我们的兜底方案</strong></p>
<p><strong>另外一种情况，我们去掉了blockHandler &#x3D; “deal_testHotKey”</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805202834440.png" alt="image-20210805202834440"></p>
<p>那么连续点击时候会产生什么效果呢？</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210805202918361.png" alt="image-20210805202918361"></p>
<h4 id="2-6-2-热点参数项"><a href="#2-6-2-热点参数项" class="headerlink" title="2.6.2 热点参数项"></a>2.6.2 热点参数项</h4><p><strong>原来：</strong>超过一秒一个后，达到阈值1后立马被限流</p>
<p>我们期望p1参数当它是某个特殊值时，它的限流值和平时不一样，<strong>假如</strong>当p1的值等于5时，它的阈值可以达到200</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806091305102.png" alt="image-20210806091305102"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806091616744.png" alt="image-20210806091616744"></p>
<h3 id="2-7-Sentinel系统规则"><a href="#2-7-Sentinel系统规则" class="headerlink" title="2.7 Sentinel系统规则"></a>2.7 Sentinel系统规则</h3><p><strong>Sentinel系统规则也叫做系统自适应限流</strong></p>
<p>Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<p><strong>背景</strong></p>
<p>在开始之前，我们先了解一下系统保护的目的：</p>
<ul>
<li>保证系统不被拖垮</li>
<li>在系统稳定的前提下，保持系统的吞吐量</li>
</ul>
<p>长期以来，系统保护的思路是根据硬指标，即系统的负载 (load1) 来做系统过载保护。当系统负载高于某个阈值，就禁止或者减少流量的进入；当 load 开始好转，则恢复流量的进入。这个思路给我们带来了不可避免的两个问题：</p>
<ul>
<li>load 是一个“结果”，如果根据 load 的情况来调节流量的通过率，那么就始终有延迟性。也就意味着通过率的任何调整，都会过一段时间才能看到效果。当前通过率是使 load 恶化的一个动作，那么也至少要过 1 秒之后才能观测到；同理，如果当前通过率调整是让 load 好转的一个动作，也需要 1 秒之后才能继续调整，这样就浪费了系统的处理能力。所以我们看到的曲线，总是会有抖动。</li>
<li>恢复慢。想象一下这样的一个场景（真实），出现了这样一个问题，下游应用不可靠，导致应用 RT 很高，从而 load 到了一个很高的点。过了一段时间之后下游应用恢复了，应用 RT 也相应减少。这个时候，其实应该大幅度增大流量的通过率；但是由于这个时候 load 仍然很高，通过率的恢复仍然不高。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/TCP_congestion_control#TCP_BBR">TCP BBR</a> 的思想给了我们一个很大的启发。我们应该根据系统能够处理的请求，和允许进来的请求，来做平衡，而不是根据一个间接的指标（系统 load）来做限流。最终我们追求的目标是 <strong>在系统不被拖垮的情况下，提高系统的吞吐率，而不是 load 一定要到低于某个阈值</strong>。如果我们还是按照固有的思维，超过特定的 load 就禁止流量进入，系统 load 恢复就放开流量，这样做的结果是无论我们怎么调参数，调比例，都是按照果来调节因，都无法取得良好的效果。</p>
<p>Sentinel 在系统自适应保护的做法是，用 load1 作为启动自适应保护的因子，而允许通过的流量由处理请求的能力，即请求的响应时间以及当前系统正在处理的请求速率来决定。</p>
<p><strong>系统规则</strong></p>
<p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<p>系统保护规则是应用整体维度的，而不是资源维度的，并且<strong>仅对入口流量生效</strong>。入口流量指的是进入应用的流量（<code>EntryType.IN</code>），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p>
<p>系统规则支持以下的模式：</p>
<ul>
<li><strong>Load 自适应</strong>（仅对 Linux&#x2F;Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li>
<li><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li>
<li><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li>
<li><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li>
</ul>
<h4 id="2-7-1-示例"><a href="#2-7-1-示例" class="headerlink" title="2.7.1 示例"></a>2.7.1 示例</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806093019941.png" alt="image-20210806093019941"></p>
<p>如上图所示：改规则面对的是系统的整个入口的限流</p>
<h3 id="2-8-SentinelResource配置"><a href="#2-8-SentinelResource配置" class="headerlink" title="2.8 SentinelResource配置"></a>2.8 SentinelResource配置</h3><h4 id="2-8-1-按资源名称限流-后续处理"><a href="#2-8-1-按资源名称限流-后续处理" class="headerlink" title="2.8.1 按资源名称限流+后续处理"></a>2.8.1 按资源名称限流+后续处理</h4><p>示例：</p>
<p><strong>配置pom</strong></p>
<p>导入common包：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>配置Controller</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RateLimitController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/byResource&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;byResource&quot;, blockHandler = &quot;handleException&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> commonResult <span class="title function_">byResource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">commonResult</span>(<span class="number">200</span>, <span class="string">&quot;按资源名称限流测试OK&quot;</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>, BigDecimal.valueOf(<span class="number">28.09</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> commonResult <span class="title function_">handleException</span><span class="params">(BlockException exception)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">commonResult</span>(<span class="number">444</span>, exception.getClass().getCanonicalName() + <span class="string">&quot;\t 服务不可用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>进行限流配置，自己观察结果。</p>
<ol>
<li>系统默认的，没有体现我们自己的业务要求。</li>
<li>依照现有条件,我们自定义的处理方法又和业务代码耦合在一块,不直观。</li>
<li>每个业务方法都添加一个兜底的，那代码膨胀加剧。</li>
<li>全局统一的处理方法没有体现。</li>
</ol>
<h4 id="2-8-2-客户自定义限流处理逻辑"><a href="#2-8-2-客户自定义限流处理逻辑" class="headerlink" title="2.8.2 客户自定义限流处理逻辑"></a>2.8.2 客户自定义限流处理逻辑</h4><p>针对上面的问题，我们来做客户自定义限流处理逻辑。</p>
<p><strong>1.首先创建自定义类，类中有两个方法。注意的是方法必须是static</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerBlockHandle</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> commonResult <span class="title function_">handlerException1</span><span class="params">(BlockException e)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">commonResult</span>(<span class="number">444</span>,<span class="string">&quot;按客户自定义1，global handlerException&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> commonResult <span class="title function_">handlerException2</span><span class="params">(BlockException e)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">commonResult</span>(<span class="number">444</span>,<span class="string">&quot;按客户自定义2，global handlerException&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>2.创建测试的方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/rateLimit/customerBlockHandler&quot;)</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;customerBlockHandler&quot;,</span></span><br><span class="line"><span class="meta">            blockHandlerClass = CustomerBlockHandle.class,blockHandler = &quot;handlerException2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> commonResult <span class="title function_">customerBlockHandler</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">commonResult</span>(<span class="number">200</span>, <span class="string">&quot;按资源名称限流测试OK&quot;</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>, BigDecimal.valueOf(<span class="number">28.09</span>)));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>@SentinelResource(value &#x3D; “customerBlockHandler”,blockHandlerClass &#x3D; CustomerBlockHandle.class,blockHandler &#x3D; “handlerException2”)</p>
</blockquote>
<p>我们对上面引用进行分析</p>
<table>
<thead>
<tr>
<th>value &#x3D; “customerBlockHandler”</th>
<th>SentinelResource指定的名字</th>
</tr>
</thead>
<tbody><tr>
<td>blockHandlerClass &#x3D; CustomerBlockHandle.class</td>
<td>表示需要引用的方法，也就是用户自定义的方法</td>
</tr>
<tr>
<td>blockHandler &#x3D; “handlerException2”</td>
<td>这个表示进一步的引用，进一步的引用自定义类中的方法</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>测试：</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806102816832.png" alt="image-20210806102816832"></p>
<p>启动成功</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806102830028.png" alt="image-20210806102830028"></p>
<p>配置成功</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806102845028.png" alt="image-20210806102845028"></p>
<p>达成限流后，成功显示用户自定义的方法信息。</p>
<h4 id="2-8-3-SentinelResource注解详解"><a href="#2-8-3-SentinelResource注解详解" class="headerlink" title="2.8.3 SentinelResource注解详解"></a>2.8.3 SentinelResource注解详解</h4><p>关于<code>@SentinelResource</code>注解最主要的两个用法：限流控制和熔断降级的具体使用案例介绍完了。另外，该注解还有一些其他更精细化的配置，比如忽略某些异常的配置、默认降级函数等等，具体可见如下说明：</p>
<ul>
<li><p><code>value</code>：资源名称，必需项（不能为空）</p>
</li>
<li><p><code>entryType</code>：entry 类型，可选项（默认为 <code>EntryType.OUT</code>）</p>
</li>
<li><p><code>blockHandler</code> &#x2F; <code>blockHandlerClass</code>: <code>blockHandler</code>对应处理 <code>BlockException</code> 的函数名称，可选项。blockHandler 函数访问范围需要是 <code>public</code>，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 <code>BlockException</code>。blockHandler 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>blockHandlerClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</p>
</li>
<li><pre><code>fallback
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">：fallback 函数名称，可选项，用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了</span><br><span class="line"></span><br></pre></td></tr></table></figure>
exceptionsToIgnore
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  里面排除掉的异常类型）进行处理。fallback 函数签名和位置要求：</span><br><span class="line"></span><br><span class="line">  - 返回值类型必须与原函数返回值类型一致；</span><br><span class="line">  - 方法参数列表需要和原函数一致，或者可以额外多一个 `Throwable` 类型的参数用于接收对应的异常。</span><br><span class="line">  - fallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 `fallbackClass` 为对应的类的 `Class` 对象，注意对应的函数必需为 static 函数，否则无法解析。</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  defaultFallback</span><br></pre></td></tr></table></figure>

（since 1.6.0）：默认的 fallback 函数名称，可选项，通常用于通用的 fallback 逻辑（即可以用于很多服务或方法）。默认 fallback 函数可以针对所有类型的异常（除了

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exceptionsToIgnore</span><br></pre></td></tr></table></figure>

里面排除掉的异常类型）进行处理。若同时配置了 fallback 和 defaultFallback，则只有 fallback 会生效。defaultFallback 函数签名要求：

- 返回值类型必须与原函数返回值类型一致；
- 方法参数列表需要为空，或者可以额外多一个 `Throwable` 类型的参数用于接收对应的异常。
- defaultFallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 `fallbackClass` 为对应的类的 `Class` 对象，注意对应的函数必需为 static 函数，否则无法解析。
</code></pre>
</li>
<li><p><code>exceptionsToIgnore</code>（since 1.6.0）：用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。</p>
</li>
</ul>
<blockquote>
<p>注：1.6.0 之前的版本 fallback 函数只针对降级异常（<code>DegradeException</code>）进行处理，<strong>不能针对业务异常进行处理</strong>。</p>
</blockquote>
<p>特别地，若 blockHandler 和 fallback 都进行了配置，则被限流降级而抛出 <code>BlockException</code> 时只会进入 <code>blockHandler</code> 处理逻辑。若未配置 <code>blockHandler</code>、<code>fallback</code> 和 <code>defaultFallback</code>，则被限流降级时会将 <code>BlockException</code> <strong>直接抛出</strong>。</p>
<p><strong>sentinel主要的三个核心API</strong></p>
<ol>
<li>SphU定义资源</li>
<li>Tracer定义统计</li>
<li>ContextUtil定义了上下文</li>
</ol>
<h3 id="2-9-Sentinel-熔断功能"><a href="#2-9-Sentinel-熔断功能" class="headerlink" title="2.9 Sentinel 熔断功能"></a>2.9 Sentinel 熔断功能</h3><h4 id="2-9-1-环境准备"><a href="#2-9-1-环境准备" class="headerlink" title="2.9.1 环境准备"></a>2.9.1 环境准备</h4><p><strong>1.新建</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806113211752.png" alt="image-20210806113211752"></p>
<p><strong>2.导入maven依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>3.配置主启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">paymentMain9003</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(paymentMain9003.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>4.新建controller类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Long, Payment&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        hashMap.put(<span class="number">1L</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">1L</span>, BigDecimal.valueOf(<span class="number">1231.12</span>)));</span><br><span class="line">        hashMap.put(<span class="number">2L</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2L</span>, BigDecimal.valueOf(<span class="number">9999.12</span>)));</span><br><span class="line">        hashMap.put(<span class="number">3L</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">3L</span>, BigDecimal.valueOf(<span class="number">8888.12</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> commonResult&lt;Payment&gt; <span class="title function_">paymentSQL</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> hashMap.get(id);</span><br><span class="line">        commonResult&lt;Payment&gt; result = <span class="keyword">new</span> <span class="title class_">commonResult</span>(<span class="number">200</span>, <span class="string">&quot;from mysql,serverPort:  &quot;</span> + serverPort, payment);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>再建cloudalibaba-consumer-nacos-order84</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806113539947.png" alt="image-20210806113539947"></p>
<p><strong>1.pom依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>2.配置yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">84</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">172.20</span><span class="number">.17</span><span class="number">.20</span><span class="string">:8001</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>3.主启动类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNacosMain84</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderNacosMain84.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>4.ApplicationContextConfig</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class ApplicationContextConfig</span><br><span class="line">&#123;</span><br><span class="line">    @Bean</span><br><span class="line">    @LoadBalanced</span><br><span class="line">    public RestTemplate getRestTemplate()</span><br><span class="line">    &#123;</span><br><span class="line">        return new RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>5.CircleBreakerController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CircleBreakerController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SERVICE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://nacos-payment-provider&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="comment">//@SentinelResource(value = &quot;fallback&quot;) //没有配置</span></span><br><span class="line">    <span class="comment">//@SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handlerFallback&quot;) //fallback只负责业务异常</span></span><br><span class="line">    <span class="comment">//@SentinelResource(value = &quot;fallback&quot;,blockHandler = &quot;blockHandler&quot;) //blockHandler只负责sentinel控制台配置违规</span></span><br><span class="line">    <span class="meta">@SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handlerFallback&quot;,blockHandler = &quot;blockHandler&quot;,</span></span><br><span class="line"><span class="meta">            exceptionsToIgnore = &#123;IllegalArgumentException.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> commonResult&lt;Payment&gt; <span class="title function_">fallback</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        commonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="string">&quot;/paymentSQL/&quot;</span>+id, commonResult.class,id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span> (<span class="string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (result.getData() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span> (<span class="string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//fallback</span></span><br><span class="line">    <span class="keyword">public</span> commonResult <span class="title function_">handlerFallback</span><span class="params">(<span class="meta">@PathVariable</span>  Long id,Throwable e)</span> &#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id, BigDecimal.valueOf(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">commonResult</span>&lt;&gt;(<span class="number">444</span>,<span class="string">&quot;兜底异常handlerFallback,exception内容  &quot;</span>+e.getMessage(),payment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//blockHandler</span></span><br><span class="line">    <span class="keyword">public</span> commonResult <span class="title function_">blockHandler</span><span class="params">(<span class="meta">@PathVariable</span>  Long id, BlockException blockException)</span> &#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payment</span>(id,BigDecimal.valueOf(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">commonResult</span>&lt;&gt;(<span class="number">445</span>,<span class="string">&quot;blockHandler-sentinel限流,无此流水: blockException  &quot;</span>+blockException.getMessage(),payment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>目的：</strong></p>
<ol>
<li>fallback管运行异常</li>
<li>blockHandler管配置违规</li>
</ol>
<h4 id="2-9-2-启动运行"><a href="#2-9-2-启动运行" class="headerlink" title="2.9.2 启动运行"></a>2.9.2 启动运行</h4><p>输入：<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/1">localhost:84&#x2F;consumer&#x2F;fallback&#x2F;1</a></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806145206201.png" alt="image-20210806145206201"></p>
<p>输入：<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/4">localhost:84&#x2F;consumer&#x2F;fallback&#x2F;4</a></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806145240309.png" alt="image-20210806145240309"></p>
<p><strong>我们发现显示error页面，不太友好，所以我们需要兜底方案。</strong></p>
<h4 id="2-9-3-只配置fallback"><a href="#2-9-3-只配置fallback" class="headerlink" title="2.9.3 只配置fallback"></a>2.9.3 只配置fallback</h4><p><strong>fallback：负责业务异常任务</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806145927570.png" alt="image-20210806145927570"></p>
<p>输入：<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/4">localhost:84&#x2F;consumer&#x2F;fallback&#x2F;4</a></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806150244829.png" alt="image-20210806150244829"></p>
<p>输入：<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/5">localhost:84&#x2F;consumer&#x2F;fallback&#x2F;5</a></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806150322206.png" alt="image-20210806150322206"></p>
<p>输入：<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/1">localhost:84&#x2F;consumer&#x2F;fallback&#x2F;1</a></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806150336937.png" alt="image-20210806150336937"></p>
<h4 id="2-9-4-只配置blockHander"><a href="#2-9-4-只配置blockHander" class="headerlink" title="2.9.4 只配置blockHander"></a>2.9.4 只配置blockHander</h4><p><strong>blockHandler只负责sentinel控制台配置违规</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806150659767.png" alt="image-20210806150659767"></p>
<p><strong>我们配置限流策略</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806151403063.png" alt="image-20210806151403063"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/1">localhost:84&#x2F;consumer&#x2F;fallback&#x2F;1</a>这个不论点多快，都不会出错</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806151419019.png" alt="image-20210806151419019"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/5">localhost:84&#x2F;consumer&#x2F;fallback&#x2F;5</a>平常点击，只会显示异常</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806151512918.png" alt="image-20210806151512918"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/5">localhost:84&#x2F;consumer&#x2F;fallback&#x2F;5</a>快速点击，就会显示blockHandler</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806151614103.png" alt="image-20210806151614103"></p>
<h4 id="2-9-5-fallback和blockHandler都配置"><a href="#2-9-5-fallback和blockHandler都配置" class="headerlink" title="2.9.5 fallback和blockHandler都配置"></a>2.9.5 fallback和blockHandler都配置</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806151917926.png" alt="image-20210806151917926"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806152212721.png" alt="image-20210806152212721"></p>
<p>**现在访问<a target="_blank" rel="noopener" href="http://localhost:84/consumer/fallback/5">localhost:84&#x2F;consumer&#x2F;fallback&#x2F;5</a>**，那么系统是既触发系统内的java异常，又触发sentinel中的异常。</p>
<p>那么听谁的呢？也就是谁的优先级高呢？</p>
<p>我们访问一下：</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806152146469.png" alt="image-20210806152146469"></p>
<p><strong>结论：blockHander优先级更高</strong></p>
<h4 id="2-9-6-exceptionsTolgnore"><a href="#2-9-6-exceptionsTolgnore" class="headerlink" title="2.9.6 exceptionsTolgnore"></a>2.9.6 exceptionsTolgnore</h4><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806152632893.png" alt="image-20210806152632893"></p>
<p>假如报该异常，不再有fallback方法兜底，没有降级效果了</p>
<p>​       、</p>
<h3 id="2-10-Sentinel服务熔断Openfeign"><a href="#2-10-Sentinel服务熔断Openfeign" class="headerlink" title="2.10 Sentinel服务熔断Openfeign"></a>2.10 Sentinel服务熔断Openfeign</h3><p><strong>修改pom</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对Feign的支持</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>







<h3 id="2-11-Sentinel持久化规则"><a href="#2-11-Sentinel持久化规则" class="headerlink" title="2.11 Sentinel持久化规则"></a>2.11 Sentinel持久化规则</h3><p><strong>选择sentinelMain8401</strong></p>
<p><strong>1.pom配置</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>新增pom配置</p>
<p><strong>2.yml配置</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">   <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">     <span class="attr">ds1:</span></span><br><span class="line">      <span class="attr">nacos:</span></span><br><span class="line">        <span class="string">server-addr:&#123;nacos的地址&#125;</span></span><br><span class="line">        <span class="string">dataid:$&#123;spring.application.name&#125;</span></span><br><span class="line">        <span class="string">groupid:DEFAULT_GROUP</span></span><br><span class="line">        <span class="string">data-type:json</span></span><br><span class="line">        <span class="string">rule-type:flow</span></span><br></pre></td></tr></table></figure>

<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806222542103.png" alt="image-20210806222542103"></p>
<p><strong>启动微服务，Sentinel自动显示</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806222615233.png" alt="image-20210806222615233"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806222626477.png" alt="image-20210806222626477"></p>
<h2 id="3-Seata-处理分布式事务"><a href="#3-Seata-处理分布式事务" class="headerlink" title="3.Seata 处理分布式事务"></a>3.Seata 处理分布式事务</h2><h3 id="3-1-起源"><a href="#3-1-起源" class="headerlink" title="3.1 起源"></a>3.1 起源</h3><p>分布式事务是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。简单来说就是一个大的操作由两个或者更多的小的操作共同完成。而这些小的操作又分布在不同的网络主机上。这些操作，要么全部成功执行，要么全部不执行。</p>
<p>PS：拿转帐来说。张三和李四在不同的城市，存储他们账户信息的服务器也在不同的网络主机上。张三有30元钱，李四有30元钱。张三给李四转账5元就是一个事务。完成这个事务，需要两个操作。首先得从张三账户上扣5元，然后再给李四账户上加5元。事务执行完毕后，必须是两个操作都执行成功，要么都失败。</p>
<p>所以本质来说，<strong>分布式事务就是为了保证不同数据库的数据一致性</strong>。</p>
<p>分布式事务之前，都是单机单库。</p>
<p>单体应用被拆分成微服务应用,原来的三个模块被拆分成三个独立的应用，分别使用三个独立的数据源,业务操作需要调用三个服务来完成。此时每个服务内部的数据一致性由本地事务来保证， 但是全局的数据一致性问题没法保证。</p>
<p>一次业务操作需要跨多个数据源或需要跨多个系统进行远程调用，就会产生分布式事务问题。</p>
<h3 id="3-2-Seate简介"><a href="#3-2-Seate简介" class="headerlink" title="3.2 Seate简介"></a>3.2 Seate简介</h3><p>Seata是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210806222450739.png" alt="image-20210806222450739"></p>
<p><strong>Seate术语</strong></p>
<p><strong>TC (Transaction Coordinator) - 事务协调者</strong></p>
<p>维护全局和分支事务的状态，驱动全局事务提交或回滚。</p>
<p><strong>TM (Transaction Manager) - 事务管理器</strong></p>
<p>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p>
<p><strong>RM (Resource Manager) - 资源管理器</strong></p>
<p>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p>
<ol>
<li>TM向TC申请开启一 个全局事務,务创建成功并生成-个全局唯一 的XID;</li>
<li>XID在微服务调用链路的上下文中传播; .</li>
<li>RM向TC注册分支事务,将其纳入XID对应全局事务的管辖;</li>
<li>TM向TC发起针对XID的全局提交或回滚决议; </li>
<li>TC调度XID下管辖的全部分支事务完成提交或回滚请求。</li>
</ol>
<h3 id="3-3-Seate的下载和安装"><a href="#3-3-Seate的下载和安装" class="headerlink" title="3.3 Seate的下载和安装"></a>3.3 Seate的下载和安装</h3><p><a target="_blank" rel="noopener" href="http://seata.io/zh-cn/blog/download.html">下载中心 (seata.io)</a></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807093116780.png" alt="image-20210807093116780"></p>
<p>打开file.conf</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807095354359.png" alt="image-20210807095354359"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807112828740.png" alt="image-20210807112828740"></p>
<p><strong>配置数据库</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807113235960.png" alt="image-20210807113235960"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span></span><br><span class="line"><span class="comment">-- the table to store GlobalSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `global_table`</span><br><span class="line">(</span><br><span class="line">    `xid`                       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`            <span class="type">BIGINT</span>,</span><br><span class="line">    `status`                    TINYINT      <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `application_id`            <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_service_group` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_name`          <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    `timeout`                   <span class="type">INT</span>,</span><br><span class="line">    `begin_time`                <span class="type">BIGINT</span>,</span><br><span class="line">    `application_data`          <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`                DATETIME,</span><br><span class="line">    `gmt_modified`              DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`xid`),</span><br><span class="line">    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),</span><br><span class="line">    KEY `idx_transaction_id` (`transaction_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `branch_table`</span><br><span class="line">(</span><br><span class="line">    `branch_id`         <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`               <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`    <span class="type">BIGINT</span>,</span><br><span class="line">    `resource_group_id` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `resource_id`       <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `branch_type`       <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">    `status`            TINYINT,</span><br><span class="line">    `client_id`         <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    `application_data`  <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`        DATETIME(<span class="number">6</span>),</span><br><span class="line">    `gmt_modified`      DATETIME(<span class="number">6</span>),</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`branch_id`),</span><br><span class="line">    KEY `idx_xid` (`xid`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `lock_table`</span><br><span class="line">(</span><br><span class="line">    `row_key`        <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`            <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    `transaction_id` <span class="type">BIGINT</span>,</span><br><span class="line">    `branch_id`      <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource_id`    <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `table_name`     <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `pk`             <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    `gmt_create`     DATETIME,</span><br><span class="line">    `gmt_modified`   DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`row_key`),</span><br><span class="line">    KEY `idx_branch_id` (`branch_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br></pre></td></tr></table></figure>

<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807113347635.png" alt="image-20210807113347635"></p>
<p><strong>更改regiter.conf</strong></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807113827600.png" alt="image-20210807113827600"></p>
<p>启动seate</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807144549411.png" alt="image-20210807144549411"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807144556718.png" alt="image-20210807144556718"></p>
<h3 id="3-4-Seate业务数据库的准备"><a href="#3-4-Seate业务数据库的准备" class="headerlink" title="3.4 Seate业务数据库的准备"></a>3.4 Seate业务数据库的准备</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create database seata_order;</span><br><span class="line"></span><br><span class="line">create database seata_storage;</span><br><span class="line"></span><br><span class="line">create database seata_account;</span><br></pre></td></tr></table></figure>

<p>先创建三个数据库；</p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807145245492.png" alt="image-20210807145245492"></p>
<p><strong>建日志回滚表</strong></p>
<p>订单-库存-账户3个库下都需要建各自的回滚日志表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `undo_log` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `branch_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `xid` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `context` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rollback_info` longblob <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_status` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_created` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ext` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/image-20210807152032291.png" alt="image-20210807152032291"></p>
<h3 id="3-5-Seata的order-module搭建"><a href="#3-5-Seata的order-module搭建" class="headerlink" title="3.5 Seata的order-module搭建"></a>3.5 Seata的order-module搭建</h3><p>业务需求：下订单-》减库存</p>
<p>​                                                                                                                      </p>
<h2 id="服务注册的对比"><a href="#服务注册的对比" class="headerlink" title="服务注册的对比"></a>服务注册的对比</h2><p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731152903.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731153405.png"></p>
<p><img src="https://ccbigsbyzdqphoto.oss-cn-guangzhou.aliyuncs.com/20210731153750.png"></p>
<p><strong>Nacos支持AP和CP模式的切换</strong></p>
<p>&#x3D;&#x3D;C是所有节点在同一时间看到的数据是一致的;而A的定义是所有的请求都会收到响应。&#x3D;&#x3D;</p>
<p>何时选择使用何种模式?</p>
<p>一般来说，如果不需要存储服务级别的信息且服务实例是通过nacos client注册，并能够保持心跳上报,那么就可以选择AP模式。当前主流的服务如Spring dloud和Dubbo服务,都适用于AP模式，AP模式为了服务的可能性而减弱了-致性,因此AP模式下只支持注册临时实例。</p>
<p>如果需要在服务级别编辑或者存储配置信息，那么CP是必须, K8S服务和DNS服务则适用于CP模式。</p>
<p>CP模式下则支持注册持久化实例，此时则是以Raft协议为集群运行模式，该模式下注册实例之前必须先注册服务,如果服务不存在,则会返回错误。</p>
<p>curl -X PUT ‘$NACOS SERVER:8848&#x2F;nacos&#x2F;v1&#x2F;ns&#x2F;operator&#x2F;swithes?entry&#x3D; serverMode&amp;value&#x3D;CP’</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">DingQuan Zuo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2021/07/28/SpringCloudAlibaba/">http://example.com/2021/07/28/SpringCloudAlibaba/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">ccbigs blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCLoud/">SpringCLoud</a><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post_share"><div class="social-share" data-image="/img/ahead.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/08/22/%E4%B8%AD%E9%97%B4%E4%BB%B6%E2%80%94%E2%80%94KAFKA/" title="中间件——KAFKA"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">中间件——KAFKA</div></div></a></div><div class="next-post pull-right"><a href="/2021/07/17/%E4%B8%AD%E9%97%B4%E4%BB%B6%E2%80%94%E2%80%94Zookeeper/" title="中间件——Zookeeper"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">中间件——Zookeeper</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/07/02/SpringCloud/" title="SpringCloud铺垫"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-02</div><div class="title">SpringCloud铺垫</div></div></a></div><div><a href="/2021/07/11/SpringCloud%E7%BB%84%E4%BB%B6/" title="SpringCloud组件"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-11</div><div class="title">SpringCloud组件</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/ahead.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">DingQuan Zuo</div><div class="author-info__description">计算机很适合我这样的蠢人学，因为代码就在那里</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ccbigs" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://blog.csdn.net/zuodingquan666" target="_blank" title="CSDN"><i class="fas fa-c" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1692062014@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloudAlibaba"><span class="toc-text">SpringCloudAlibaba</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Nacos-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-text">1.Nacos 服务注册和配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85Nacos"><span class="toc-text">1.1 下载并安装Nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E8%BF%9B%E5%85%A5Nacos"><span class="toc-text">1.2 服务注册进入Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-%E6%96%B0%E5%BB%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%8D%E5%8A%A1"><span class="toc-text">1.2.1 新建客户端服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-%E6%B7%BB%E5%8A%A0pom%E4%BE%9D%E8%B5%96"><span class="toc-text">1.2.2 添加pom依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-%E5%88%9B%E5%BB%BA%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-text">1.2.3 创建主启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-4-%E5%88%9B%E5%BB%BAcontroller%E7%B1%BB"><span class="toc-text">1.2.4 创建controller类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-6-%E9%85%8D%E7%BD%AEyml"><span class="toc-text">1.2.6 配置yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-7-%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE"><span class="toc-text">1.2.7 启动项目</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E6%B6%88%E8%B4%B9%E8%80%85%E5%85%A5%E9%A9%BBNacos"><span class="toc-text">1.3消费者入驻Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1%E5%88%9B%E5%BB%BA%E6%B6%88%E8%B4%B9%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">1.3.1创建消费微服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-%E6%96%B0%E5%BB%BA%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-text">1.3.2 新建启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-%E5%88%9B%E5%BB%BAyml"><span class="toc-text">1.3.3 创建yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-4-%E5%88%9B%E5%BB%BAconfig%E7%B1%BB"><span class="toc-text">1.3.4 创建config类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-5-%E5%88%9B%E5%BB%BAcontroller%E7%B1%BB"><span class="toc-text">1.3.5 创建controller类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-6-%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE"><span class="toc-text">1.3.6 启动项目</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-Nacos%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA"><span class="toc-text">1.4 Nacos作为服务配置中心演示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-text">1.4.1  创建项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-%E5%AF%BC%E5%85%A5pom"><span class="toc-text">1.4.2 导入pom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-%E9%85%8D%E7%BD%AEyml"><span class="toc-text">1.4.3 配置yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-4-%E9%85%8D%E7%BD%AE%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-text">1.4.4 配置主启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-5-%E9%85%8D%E7%BD%AEController"><span class="toc-text">1.4.5 配置Controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-6-%E9%85%8D%E7%BD%AEnacos%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E5%88%97%E8%A1%A8"><span class="toc-text">1.4.6 配置nacos中的配置列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-7-Nacos%E8%87%AA%E5%B8%A6%E5%88%B7%E6%96%B0%E5%8A%9F%E8%83%BD"><span class="toc-text">1.4.7 Nacos自带刷新功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-Nacos%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E5%88%86%E7%B1%BB%E9%85%8D%E7%BD%AE"><span class="toc-text">1.5 Nacos作为配置中心-分类配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1-%E5%A4%9A%E7%8E%AF%E5%A2%83%E5%A4%9A%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86"><span class="toc-text">1.5.1 多环境多项目管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2-Nacos%E5%9B%BE%E5%BD%A2%E5%8C%96%E8%AE%BE%E8%AE%A1%E9%A1%B5%E9%9D%A2"><span class="toc-text">1.5.2 Nacos图形化设计页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-3-Namespace-Group-Data-ID%E4%B8%89%E8%80%85%E5%85%B3%E7%B3%BB"><span class="toc-text">1.5.3 Namespace+Group+Data ID三者关系</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-5-3-1-Nacos%E4%B9%8BDataID%E9%85%8D%E7%BD%AE"><span class="toc-text">1.5.3.1 Nacos之DataID配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-5-3-2-Group%E7%BB%84"><span class="toc-text">1.5.3.2 Group组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-5-1-3-NameSpace%E7%A9%BA%E9%97%B4%E6%96%B9%E6%A1%88"><span class="toc-text">1.5.1.3 NameSpace空间方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-Nacos%E9%9B%86%E7%BE%A4%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-text">1.6 Nacos集群和持久化配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-x-Nacos%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-text">1.6.x Nacos集群配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AEmysql%E7%9A%84sql%E6%96%87%E4%BB%B6"><span class="toc-text">1. 配置mysql的sql文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-application-properties-%E9%85%8D%E7%BD%AE"><span class="toc-text">2. application.properties 配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Sentinel-%E5%93%A8%E5%85%B5"><span class="toc-text">2.Sentinel 哨兵</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%88%9D%E8%AF%86Sentinel"><span class="toc-text">2.1 初识Sentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E4%B8%8B%E8%BD%BD%E3%80%81%E5%AE%89%E8%A3%85%E3%80%81%E9%85%8D%E7%BD%AE"><span class="toc-text">2.2 下载、安装、配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Sentinel%E7%9B%91%E6%8E%A7%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.3 Sentinel监控微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E6%96%B0%E5%BB%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.3.1 新建微服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E5%BB%BAPOM"><span class="toc-text">2.3.2 建POM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-text">2.3.3 主启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-4-controller%E7%B1%BB"><span class="toc-text">2.3.4 controller类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-5-Sentinel"><span class="toc-text">2.3.5 Sentinel</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Sentinel%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E7%AE%80%E4%BB%8B"><span class="toc-text">2.4 Sentinel流控规则简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E7%BC%96%E5%86%99%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-text">2.4.2 编写流控规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-%E6%80%9D%E8%80%83"><span class="toc-text">2.4.3 思考</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-4-%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F-%E5%85%B3%E8%81%94"><span class="toc-text">2.4.4 流控模式-关联</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-5-%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F-%E9%93%BE%E8%B7%AF"><span class="toc-text">2.4.5 流控模式-链路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-6-%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C-Warm-Up-%E9%A2%84%E7%83%AD"><span class="toc-text">2.4.6 流控效果-Warm Up(预热)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-7-%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C-%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-text">2.4.7 流控效果-排队等待</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Sentinel%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99"><span class="toc-text">2.5 Sentinel降级规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5"><span class="toc-text">2.5.1 熔断策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-2-%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B"><span class="toc-text">2.5.2 熔断策略-慢调用比例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-3-%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="toc-text">2.5.3 熔断策略-异常比例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-4-%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-text">2.5.4 熔断策略-异常数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-Sentinel-%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="toc-text">2.6 Sentinel 热点规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="toc-text">2.6.1 基本配置示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%A1%B9"><span class="toc-text">2.6.2 热点参数项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-Sentinel%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="toc-text">2.7 Sentinel系统规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-7-1-%E7%A4%BA%E4%BE%8B"><span class="toc-text">2.7.1 示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-SentinelResource%E9%85%8D%E7%BD%AE"><span class="toc-text">2.8 SentinelResource配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-1-%E6%8C%89%E8%B5%84%E6%BA%90%E5%90%8D%E7%A7%B0%E9%99%90%E6%B5%81-%E5%90%8E%E7%BB%AD%E5%A4%84%E7%90%86"><span class="toc-text">2.8.1 按资源名称限流+后续处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-2-%E5%AE%A2%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-text">2.8.2 客户自定义限流处理逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-3-SentinelResource%E6%B3%A8%E8%A7%A3%E8%AF%A6%E8%A7%A3"><span class="toc-text">2.8.3 SentinelResource注解详解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-Sentinel-%E7%86%94%E6%96%AD%E5%8A%9F%E8%83%BD"><span class="toc-text">2.9 Sentinel 熔断功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">2.9.1 环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-2-%E5%90%AF%E5%8A%A8%E8%BF%90%E8%A1%8C"><span class="toc-text">2.9.2 启动运行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-3-%E5%8F%AA%E9%85%8D%E7%BD%AEfallback"><span class="toc-text">2.9.3 只配置fallback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-4-%E5%8F%AA%E9%85%8D%E7%BD%AEblockHander"><span class="toc-text">2.9.4 只配置blockHander</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-5-fallback%E5%92%8CblockHandler%E9%83%BD%E9%85%8D%E7%BD%AE"><span class="toc-text">2.9.5 fallback和blockHandler都配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-6-exceptionsTolgnore"><span class="toc-text">2.9.6 exceptionsTolgnore</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-Sentinel%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%ADOpenfeign"><span class="toc-text">2.10 Sentinel服务熔断Openfeign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-Sentinel%E6%8C%81%E4%B9%85%E5%8C%96%E8%A7%84%E5%88%99"><span class="toc-text">2.11 Sentinel持久化规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Seata-%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">3.Seata 处理分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%B5%B7%E6%BA%90"><span class="toc-text">3.1 起源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Seate%E7%AE%80%E4%BB%8B"><span class="toc-text">3.2 Seate简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Seate%E7%9A%84%E4%B8%8B%E8%BD%BD%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-text">3.3 Seate的下载和安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Seate%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-text">3.4 Seate业务数据库的准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-Seata%E7%9A%84order-module%E6%90%AD%E5%BB%BA"><span class="toc-text">3.5 Seata的order-module搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-text">服务注册的对比</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/10/21/appInstall%E2%80%94%E2%80%94Java%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4/" title="appInstall——Java安装步骤">appInstall——Java安装步骤</a><time datetime="2024-10-21T02:20:13.000Z" title="发表于 2024-10-21 10:20:13">2024-10-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/15/Rust%20%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E8%AF%AD%E8%A8%80/" title="Rust 程序设计语言">Rust 程序设计语言</a><time datetime="2024-09-15T11:19:19.000Z" title="发表于 2024-09-15 19:19:19">2024-09-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/28/appInstall%E2%80%94%E2%80%94mysql_windows%E7%89%88%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%80%E6%98%93%E5%8C%96%E5%AE%89%E8%A3%85/" title="appInstall——mysql_windows版自定义简易化安装">appInstall——mysql_windows版自定义简易化安装</a><time datetime="2024-06-28T07:20:13.000Z" title="发表于 2024-06-28 15:20:13">2024-06-28</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/1558.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By DingQuan Zuo</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">道可道，非恒道也！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>